<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.14.5"/><meta name="theme-color" content="#663399"/><style data-href="/styles.6c1a2463dfca1feea278.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}#MainLayout{margin-left:auto;margin-right:auto;max-width:60rem;padding:2rem}body{font-family:Merriweather,Arial,Helvetica,sans-serif}pre{white-space:pre-wrap}:root{--dark-bg-color:#2a2a2e;--dark-font-color:hsla(240,9%,98%,.8)}@media (prefers-color-scheme:dark){body{background-color:var(--dark-bg-color);color:var(--dark-font-color)}a:link{color:#f3d009}a:visited{color:#d39c06}}</style><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="true"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&amp;display=swap"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div id="MainLayout"><header id="SiteTitle"><h1 style="margin:0"><a href="/">Dev Blog</a></h1></header><main><h1>How to make Authentik Proxy Provider work with Immich, including the Immich Mobile App</h1><h4><em>Date published: <!-- -->2025-08-02</em></h4><div><h2>Background</h2>
<p>If you're exposing your Immich instance to the web, ideally it is protected behind an authentication proxy like Authentik. Technically it's easier to 'just' expose Immich directly and just use Authentik as an OAuth provider but you are exposed to vulnerabilities in Immich which can be exploited without the user being logged in. Ideally everything should pass through Authentik first.</p>
<p>So here's what I want to achieve:</p>
<ol>
<li>Someone visits immich.mydomain</li>
<li>Authentik intercepts that request and requires the person to log in.</li>
<li>Once the person is logged in, they are redirected to Immich</li>
<li>They are immediately logged into Immich since they are already authenticated with Authentik</li>
<li>Also, this should work with the Mobile App, which is slightly more complicated. I will explain a little further down.</li>
</ol>
<p>This guide should be generally applicable to most setups with a Reverse Proxy, Authentik, and Immich. In my examples, I will use Caddy as my reverse proxy.</p>
<h2>Steps: Getting Immich OAuth work with Authentik</h2>
<p>This is pretty simple: Just follow the <a href="https://immich.app/docs/administration/oauth/">official instructions from Immich</a>.</p>
<p>Note that after you complete this step, you will have the following setup in your reverse proxy:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">immich.yourdomain {
	handle {
		reverse_proxy &lt;Immich ip address:port> {
		}
	}
}

authentik.yourdomain {
	handle {
		reverse_proxy &lt;Authentik ip address:port> {
		}
	}
}</code></pre></div>
<p>In short, users visiting <code class="language-text">immich.yourdomain</code> will be directly forwarded to Immich. If a malicious attacker can craft a payload targeting <code class="language-text">immich.yourdomain/api/sensitive-stuff</code>, they theoretically could obtain sensitive data. Ideally, all traffic should go through Authentik first.</p>
<h2>Steps: Getting Authentik to proxy requests to Immich.</h2>
<p>Authentik provides a 'Proxy Provider' that achieves what we want.</p>
<p>Create an Authentik Proxy Application + Provider by going to:</p>
<ol>
<li>Applications -> 'Create with Provider'</li>
<li>Choose 'Proxy Provider'</li>
<li>Between 'Proxy', 'Forward Auth (single application)', 'Forward Auth (domain level)', choose 'Proxy'. (Technically Forward Auth should work but I didn't get it working)</li>
<li>For 'External host', input <code class="language-text">https://immich.yourdomain</code></li>
<li>For 'Internal host', input your local <code class="language-text">&lt;Immich ip address:port></code></li>
<li>I have internal host SSL validation off</li>
<li>Leave the rest as default and finish up.</li>
</ol>
<p>Now, update your Caddy config to point <code class="language-text">immich.yourdomain</code> to Authentik.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">immich.yourdomain {
	handle {
		reverse_proxy &lt;Authentik ip address:port> {
		}
	}
}

authentik.yourdomain {
	handle {
		reverse_proxy &lt;Authentik ip address:port> {
		}
	}
}</code></pre></div>
<p>Now try accessing <code class="language-text">immich.yourdomain</code> in your browser (ideally in a private window). You will arrive at the Authentik screen asking you to login. Once you've logged in (via OAuth, e.g. Google login), you should be forwarded to Immich and you will automatically be logged in after a few redirects.</p>
<p>So the flow looks something like</p>
<ol>
<li>Access <code class="language-text">immich.yourdomain</code></li>
<li>Authentik Proxy Provider intercepts request and initiates login flow.</li>
<li>User authenticates with Authentik Proxy Provider, Authentik forwards request to Immich.</li>
<li>Immich initiates OAuth login flow, redirecting to Authentik OAuth Provider</li>
<li>User was already authenticated, Authentik OAuth Provider authenticates the request</li>
<li>User is now logged into Immich :)</li>
</ol>
<h2>Steps: Getting Authentik Proxy Provider to work with Immich Mobile App</h2>
<p>You will notice that the current setup won't work with the Immich Mobile App. That's because the app doesn't support the initial redirect when Authentik Proxy Provider intercepts the request to initiate the login flow.</p>
<p>To get the Mobile App working, you will need to <em>pre-authenticate</em> the user to Authentik <em>Proxy Provider</em>. (Then the user can use the regular login flow to authenticate to Authentik <em>OAuth Provider</em>)</p>
<p>A similar setup exists using Cloudflare Tunnels, as described in <a href="https://www.youtube.com/watch?v=J4vVYFVWu5Q">this guide</a>. Instead of using Service Tokens (<code class="language-text">CF-Access-Client-Id</code>, <code class="language-text">CF-Access-Client-Secret</code>), we will use Authentik's Service Account and App Passwords.</p>
<p>Here's how to go about doing it:</p>
<ol>
<li>In Authentik, go to Directory -> Users -> Create Service Account</li>
<li>Configure the user however you like.</li>
<li>Copy the username and password.</li>
<li>Base64 encode the username and password, joined by a colon: <code class="language-text">&lt;username>:&lt;password></code>. On UNIX systems, you can do: <code class="language-text">echo -n '&lt;username>:&lt;password>' | base64</code></li>
<li>Go to your Immich Mobile app, click the gear Settings icon.</li>
<li>Go to Advanced -> Custom proxy headers</li>
<li>For Header name, input 'Authorization'</li>
<li>For Header value, input 'Basic <base64 encoded username and password>'</li>
<li>Now you can log into your Immich Mobile App! You will still need to complete the regular login process for Immich.</li>
</ol>
<p>Feel free to create a new Service Account for each Immich user that you are administering. So you can revoke a Service Account as needed without impacting all of your users.</p></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/entry/authentik-proxy-with-immich/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-2360ce01572022419a49.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-cabbaeae1c9b2492f160.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-aae008b978def4d8979f.js\"],\"component---src-templates-blog-entry-template-js\":[\"/component---src-templates-blog-entry-template-js-ff0fb9e40fb0d22befd7.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="f94acb2d5ce8dda1934f";</script><script src="/webpack-runtime-788dbbb2340ddb40f1d6.js" async></script><script src="/framework-a98cd6097609b685b73f.js" async></script><script src="/app-2360ce01572022419a49.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>